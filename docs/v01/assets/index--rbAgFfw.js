import{WASI as I,OpenFile as x,ConsoleStdout as k,PreopenDirectory as R,File as D}from"https://cdn.jsdelivr.net/npm/@bjorn3/browser_wasi_shim@0.4.1/+esm";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function o(e){const s={};return e.integrity&&(s.integrity=e.integrity),e.referrerPolicy&&(s.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?s.credentials="include":e.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(e){if(e.ep)return;e.ep=!0;const s=o(e);fetch(e.href,s)}})();class S{constructor(r){if(typeof FinalizationRegistry>"u")throw new Error("The Swift part of JavaScriptKit was configured to require the availability of JavaScript WeakRefs. Please build with `-Xswiftc -DJAVASCRIPTKIT_WITHOUT_WEAKREFS` to disable features that use WeakRefs.");this.functionRegistry=new FinalizationRegistry(o=>{r.swjs_free_host_function(o)})}track(r,o){this.functionRegistry.register(r,o)}}function E(h,r){throw new Error(r)}const g=-1,T=(h,r,o,t)=>{switch(h){case 0:switch(r){case 0:return!1;case 1:return!0}case 2:return o;case 1:case 3:case 7:case 8:return t.getObject(r);case 4:return null;case 5:return;default:E(h,`JSValue Type kind "${h}" is not supported`)}},_=(h,r,o,t)=>{if(r===0)return[];let e=[];for(let s=0;s<r;s++){const n=h+16*s,i=o.getUint32(n,!0),a=o.getUint32(n+4,!0),c=o.getFloat64(n+8,!0);e.push(T(i,a,c,t))}return e},b=(h,r,o,t,e,s,n)=>{const i=w(h,o,t,e,s,n);s.setUint32(r,i,!0)},w=(h,r,o,t,e,s)=>{const n=(t?1:0)<<31;if(h===null)return n|4;const i=c=>(e.setUint32(r,s.retain(h),!0),n|c),a=typeof h;switch(a){case"boolean":return e.setUint32(r,h?1:0,!0),n|0;case"number":return e.setFloat64(o,h,!0),n|2;case"string":return i(1);case"undefined":return n|5;case"object":return i(3);case"function":return i(3);case"symbol":return i(7);case"bigint":return i(8);default:E(a,`Type "${a}" is not supported yet`)}throw new Error("Unreachable")};function j(h,r,o){const t=new Array(r);for(let e=0;e<r;e++)t[e]=o.getUint32(h+4*e,!0);return t}class V{constructor(r){this.memory=r}send(r,o,t){const e=this.memory.getObject(r),s=o.map(n=>this.memory.getObject(n));return{object:e,sendingContext:t,transfer:s}}sendObjects(r,o,t){const e=r.map(n=>this.memory.getObject(n)),s=o.map(n=>this.memory.getObject(n));return{object:e,sendingContext:t,transfer:s}}release(r){return this.memory.release(r),{object:void 0,transfer:[]}}}class A{constructor(r,o,t){this.selfTid=r,this.threadChannel=o,this.handlers=t}request(r){if(r.data.targetTid==this.selfTid)this.handlers.onRequest(r);else if("postMessageToWorkerThread"in this.threadChannel)this.threadChannel.postMessageToWorkerThread(r.data.targetTid,r,[]);else if("postMessageToMainThread"in this.threadChannel)this.threadChannel.postMessageToMainThread(r,[]);else throw new Error("unreachable")}reply(r){if(r.data.sourceTid==this.selfTid){this.handlers.onResponse(r);return}const o=r.data.response.ok?r.data.response.value.transfer:[];if("postMessageToWorkerThread"in this.threadChannel)this.threadChannel.postMessageToWorkerThread(r.data.sourceTid,r,o);else if("postMessageToMainThread"in this.threadChannel)this.threadChannel.postMessageToMainThread(r,o);else throw new Error("unreachable")}onReceivingRequest(r){if(r.data.targetTid==this.selfTid)this.handlers.onRequest(r);else if("postMessageToWorkerThread"in this.threadChannel)this.threadChannel.postMessageToWorkerThread(r.data.targetTid,r,[]);else if("postMessageToMainThread"in this.threadChannel)throw new Error("unreachable")}onReceivingResponse(r){if(r.data.sourceTid==this.selfTid)this.handlers.onResponse(r);else if("postMessageToWorkerThread"in this.threadChannel){const o=r.data.response.ok?r.data.response.value.transfer:[];this.threadChannel.postMessageToWorkerThread(r.data.sourceTid,r,o)}else if("postMessageToMainThread"in this.threadChannel)throw new Error("unreachable")}}function v(h){return h instanceof Error?{isError:!0,value:{message:h.message,name:h.name,stack:h.stack}}:{isError:!1,value:h}}function B(h){return h.isError?Object.assign(new Error(h.value.message),h.value):h.value}let m;typeof globalThis<"u"?m=globalThis:typeof window<"u"?m=window:typeof global<"u"?m=global:typeof self<"u"&&(m=self);class C{constructor(){this._heapValueById=new Map,this._heapValueById.set(1,m),this._heapEntryByValue=new Map,this._heapEntryByValue.set(m,{id:1,rc:1}),this._heapNextKey=2}retain(r){const o=this._heapEntryByValue.get(r);if(o)return o.rc++,o.id;const t=this._heapNextKey++;return this._heapValueById.set(t,r),this._heapEntryByValue.set(r,{id:t,rc:1}),t}retainByRef(r){return this.retain(this.getObject(r))}release(r){const o=this._heapValueById.get(r),t=this._heapEntryByValue.get(o);t.rc--,t.rc==0&&(this._heapEntryByValue.delete(o),this._heapValueById.delete(r))}getObject(r){const o=this._heapValueById.get(r);if(o===void 0)throw new ReferenceError("Attempted to read invalid reference "+r);return o}}class W{constructor(r){this.version=708,this.textDecoder=new TextDecoder("utf-8"),this.textEncoder=new TextEncoder,this.UnsafeEventLoopYield=p,this.importObjects=()=>this.wasmImports,this._instance=null,this.memory=new C,this._closureDeallocator=null,this.tid=null,this.options=r||{},this.getDataView=()=>{throw new Error("Please call setInstance() before using any JavaScriptKit APIs from Swift.")},this.getUint8Array=()=>{throw new Error("Please call setInstance() before using any JavaScriptKit APIs from Swift.")},this.wasmMemory=null}setInstance(r){this._instance=r;const o=r.exports.memory;if(o instanceof WebAssembly.Memory){let t=new DataView(o.buffer),e=new Uint8Array(o.buffer);Object.getPrototypeOf(o.buffer).constructor.name==="SharedArrayBuffer"?(this.getDataView=()=>(t.buffer!==o.buffer&&(t=new DataView(o.buffer)),t),this.getUint8Array=()=>(e.buffer!==o.buffer&&(e=new Uint8Array(o.buffer)),e)):(this.getDataView=()=>(t.buffer.byteLength===0&&(t=new DataView(o.buffer)),t),this.getUint8Array=()=>(e.byteLength===0&&(e=new Uint8Array(o.buffer)),e)),this.wasmMemory=o}else throw new Error("instance.exports.memory is not a WebAssembly.Memory!?");if(typeof this.exports._start=="function")throw new Error(`JavaScriptKit supports only WASI reactor ABI.
                Please make sure you are building with:
                -Xswiftc -Xclang-linker -Xswiftc -mexec-model=reactor
                `);if(this.exports.swjs_library_version()!=this.version)throw new Error(`The versions of JavaScriptKit are incompatible.
                WebAssembly runtime ${this.exports.swjs_library_version()} != JS runtime ${this.version}`)}main(){const r=this.instance;try{typeof r.exports.main=="function"?r.exports.main():typeof r.exports.__main_argc_argv=="function"&&r.exports.__main_argc_argv(0,0)}catch(o){if(o instanceof p)return;throw o}}startThread(r,o){this.tid=r;const t=this.instance;try{if(typeof t.exports.wasi_thread_start=="function")t.exports.wasi_thread_start(r,o);else throw new Error("The WebAssembly module is not built for wasm32-unknown-wasip1-threads target.")}catch(e){if(e instanceof p)return;throw e}}get instance(){if(!this._instance)throw new Error("WebAssembly instance is not set yet");return this._instance}get exports(){return this.instance.exports}get closureDeallocator(){return this._closureDeallocator?this._closureDeallocator:((this.exports.swjs_library_features()&1)!=0&&(this._closureDeallocator=new S(this.exports)),this._closureDeallocator)}callHostFunction(r,o,t,e){const s=e.length,n=this.exports.swjs_prepare_host_function_call(s),i=this.memory,a=this.getDataView();for(let f=0;f<e.length;f++){const d=e[f],y=n+16*f;b(d,y,y+4,y+8,!1,a,i)}let c;const l=i.retain(f=>{c=f});if(this.exports.swjs_call_host_function(r,n,s,l))throw new Error(`The JSClosure has been already released by Swift side. The closure is created at ${t}:${o} @${r}`);return this.exports.swjs_cleanup_host_function_call(n),c}get wasmImports(){let r=null;const o=t=>{var e;if(r)return r;const s=new V(this.memory),n=new A((e=this.tid)!==null&&e!==void 0?e:-1,t,{onRequest:i=>{let a;try{a={ok:!0,value:s[i.data.request.method](...i.data.request.parameters)}}catch(l){a={ok:!1,error:v(l)}}const c={type:"response",data:{sourceTid:i.data.sourceTid,context:i.data.context,response:a}};try{n.reply(c)}catch(l){c.data.response={ok:!1,error:v(new TypeError(`Failed to serialize message: ${l}`))},n.reply(c)}},onResponse:i=>{if(i.data.response.ok){const a=this.memory.retain(i.data.response.value.object);this.exports.swjs_receive_response(a,i.data.context)}else{const a=B(i.data.response.error),c=this.memory.retain(a);this.exports.swjs_receive_error(c,i.data.context)}}});return r=n,n};return{swjs_set_prop:(t,e,s,n,i)=>{const a=this.memory,c=a.getObject(t),l=a.getObject(e),u=T(s,n,i,a);c[l]=u},swjs_get_prop:(t,e,s,n)=>{const i=this.memory,a=i.getObject(t),c=i.getObject(e),l=a[c];return w(l,s,n,!1,this.getDataView(),this.memory)},swjs_set_subscript:(t,e,s,n,i)=>{const a=this.memory,c=a.getObject(t),l=T(s,n,i,a);c[e]=l},swjs_get_subscript:(t,e,s,n)=>{const a=this.memory.getObject(t)[e];return w(a,s,n,!1,this.getDataView(),this.memory)},swjs_encode_string:(t,e)=>{const s=this.memory,n=this.textEncoder.encode(s.getObject(t)),i=s.retain(n);return this.getDataView().setUint32(e,i,!0),n.length},swjs_decode_string:this.options.sharedMemory==!0?((t,e)=>{const s=this.getUint8Array().slice(t,t+e),n=this.textDecoder.decode(s);return this.memory.retain(n)}):((t,e)=>{const s=this.getUint8Array().subarray(t,t+e),n=this.textDecoder.decode(s);return this.memory.retain(n)}),swjs_load_string:(t,e)=>{const s=this.memory.getObject(t);this.getUint8Array().set(s,e)},swjs_call_function:(t,e,s,n,i)=>{const a=this.memory,c=a.getObject(t);let l;try{const u=_(e,s,this.getDataView(),a);l=c(...u)}catch(u){return w(u,n,i,!0,this.getDataView(),this.memory)}return w(l,n,i,!1,this.getDataView(),this.memory)},swjs_call_function_no_catch:(t,e,s,n,i)=>{const a=this.memory,c=a.getObject(t),l=_(e,s,this.getDataView(),a),u=c(...l);return w(u,n,i,!1,this.getDataView(),this.memory)},swjs_call_function_with_this:(t,e,s,n,i,a)=>{const c=this.memory,l=c.getObject(t),u=c.getObject(e);let f;try{const d=_(s,n,this.getDataView(),c);f=u.apply(l,d)}catch(d){return w(d,i,a,!0,this.getDataView(),this.memory)}return w(f,i,a,!1,this.getDataView(),this.memory)},swjs_call_function_with_this_no_catch:(t,e,s,n,i,a)=>{const c=this.memory,l=c.getObject(t),u=c.getObject(e);let f;const d=_(s,n,this.getDataView(),c);return f=u.apply(l,d),w(f,i,a,!1,this.getDataView(),this.memory)},swjs_call_new:(t,e,s)=>{const n=this.memory,i=n.getObject(t),a=_(e,s,this.getDataView(),n),c=new i(...a);return this.memory.retain(c)},swjs_call_throwing_new:(t,e,s,n,i,a)=>{let c=this.memory;const l=c.getObject(t);let u;try{const f=_(e,s,this.getDataView(),c);u=new l(...f)}catch(f){return b(f,n,i,a,!0,this.getDataView(),this.memory),-1}return c=this.memory,b(null,n,i,a,!1,this.getDataView(),c),c.retain(u)},swjs_instanceof:(t,e)=>{const s=this.memory,n=s.getObject(t),i=s.getObject(e);return n instanceof i},swjs_value_equals:(t,e)=>{const s=this.memory,n=s.getObject(t),i=s.getObject(e);return n==i},swjs_create_function:(t,e,s)=>{var n;const i=this.memory.getObject(s),a=(...l)=>this.callHostFunction(t,e,i,l),c=this.memory.retain(a);return(n=this.closureDeallocator)===null||n===void 0||n.track(a,t),c},swjs_create_oneshot_function:(t,e,s)=>{const n=this.memory.getObject(s),i=(...c)=>this.callHostFunction(t,e,n,c);return this.memory.retain(i)},swjs_create_typed_array:(t,e,s)=>{const n=this.memory.getObject(t);if(s==0)return this.memory.retain(new n);const i=new n(this.wasmMemory.buffer,e,s);return this.memory.retain(i.slice())},swjs_create_object:()=>this.memory.retain({}),swjs_load_typed_array:(t,e)=>{const n=this.memory.getObject(t),i=new Uint8Array(n.buffer);this.getUint8Array().set(i,e)},swjs_release:t=>{this.memory.release(t)},swjs_release_remote:(t,e)=>{var s;if(!this.options.threadChannel)throw new Error("threadChannel is not set in options given to SwiftRuntime. Please set it to release objects on remote threads.");o(this.options.threadChannel).request({type:"request",data:{sourceTid:(s=this.tid)!==null&&s!==void 0?s:g,targetTid:t,context:0,request:{method:"release",parameters:[e]}}})},swjs_i64_to_bigint:(t,e)=>this.memory.retain(e?t:BigInt.asUintN(64,t)),swjs_bigint_to_i64:(t,e)=>{const s=this.memory.getObject(t);if(typeof s!="bigint")throw new Error(`Expected a BigInt, but got ${typeof s}`);return e?s:s<BigInt(0)?BigInt(0):BigInt.asIntN(64,s)},swjs_i64_to_bigint_slow:(t,e,s)=>{const n=BigInt.asUintN(32,BigInt(t))+(BigInt.asUintN(32,BigInt(e))<<BigInt(32));return this.memory.retain(s?BigInt.asIntN(64,n):BigInt.asUintN(64,n))},swjs_unsafe_event_loop_yield:()=>{throw new p},swjs_send_job_to_main_thread:t=>{this.postMessageToMainThread({type:"job",data:t})},swjs_listen_message_from_main_thread:()=>{const t=this.options.threadChannel;if(!(t&&"listenMessageFromMainThread"in t))throw new Error("listenMessageFromMainThread is not set in options given to SwiftRuntime. Please set it to listen to wake events from the main thread.");const e=o(t);t.listenMessageFromMainThread(s=>{switch(s.type){case"wake":this.exports.swjs_wake_worker_thread();break;case"request":{e.onReceivingRequest(s);break}case"response":{e.onReceivingResponse(s);break}default:const n=s;throw new Error(`Unknown message type: ${n}`)}})},swjs_wake_up_worker_thread:t=>{this.postMessageToWorkerThread(t,{type:"wake"})},swjs_listen_message_from_worker_thread:t=>{const e=this.options.threadChannel;if(!(e&&"listenMessageFromWorkerThread"in e))throw new Error("listenMessageFromWorkerThread is not set in options given to SwiftRuntime. Please set it to listen to jobs from worker threads.");const s=o(e);e.listenMessageFromWorkerThread(t,n=>{switch(n.type){case"job":this.exports.swjs_enqueue_main_job_from_worker(n.data);break;case"request":{s.onReceivingRequest(n);break}case"response":{s.onReceivingResponse(n);break}default:const i=n;throw new Error(`Unknown message type: ${i}`)}})},swjs_terminate_worker_thread:t=>{var e;const s=this.options.threadChannel;s&&"terminateWorkerThread"in s&&((e=s.terminateWorkerThread)===null||e===void 0||e.call(s,t))},swjs_get_worker_thread_id:()=>this.tid||-1,swjs_request_sending_object:(t,e,s,n,i)=>{var a;if(!this.options.threadChannel)throw new Error("threadChannel is not set in options given to SwiftRuntime. Please set it to request transferring objects.");const c=o(this.options.threadChannel),l=j(e,s,this.getDataView());c.request({type:"request",data:{sourceTid:(a=this.tid)!==null&&a!==void 0?a:g,targetTid:n,context:i,request:{method:"send",parameters:[t,l,i]}}})},swjs_request_sending_objects:(t,e,s,n,i,a)=>{var c;if(!this.options.threadChannel)throw new Error("threadChannel is not set in options given to SwiftRuntime. Please set it to request transferring objects.");const l=o(this.options.threadChannel),u=this.getDataView(),f=j(t,e,u),d=j(s,n,u);l.request({type:"request",data:{sourceTid:(c=this.tid)!==null&&c!==void 0?c:g,targetTid:i,context:a,request:{method:"sendObjects",parameters:[f,d,a]}}})}}}postMessageToMainThread(r,o=[]){const t=this.options.threadChannel;if(!(t&&"postMessageToMainThread"in t))throw new Error("postMessageToMainThread is not set in options given to SwiftRuntime. Please set it to send messages to the main thread.");t.postMessageToMainThread(r,o)}postMessageToWorkerThread(r,o,t=[]){const e=this.options.threadChannel;if(!(e&&"postMessageToWorkerThread"in e))throw new Error("postMessageToWorkerThread is not set in options given to SwiftRuntime. Please set it to send messages to worker threads.");e.postMessageToWorkerThread(r,o,t)}}class p extends Error{}const U="App.wasm";async function q(h,r){return{addImports:(o,t)=>{const e=()=>{throw new Error("Unexpected call to BridgeJS function")};o.bjs={swift_js_return_string:e,swift_js_init_memory:e,swift_js_make_js_string:e,swift_js_init_memory_with_result:e,swift_js_throw:e,swift_js_retain:e,swift_js_release:e,swift_js_push_tag:e,swift_js_push_int:e,swift_js_push_f32:e,swift_js_push_f64:e,swift_js_push_string:e,swift_js_pop_param_int32:e,swift_js_pop_param_f32:e,swift_js_pop_param_f64:e,swift_js_return_optional_bool:e,swift_js_return_optional_int:e,swift_js_return_optional_string:e,swift_js_return_optional_double:e,swift_js_return_optional_float:e,swift_js_return_optional_heap_object:e,swift_js_return_optional_object:e,swift_js_get_optional_int_presence:e,swift_js_get_optional_int_value:e,swift_js_get_optional_string:e,swift_js_get_optional_float_presence:e,swift_js_get_optional_float_value:e,swift_js_get_optional_double_presence:e,swift_js_get_optional_double_value:e,swift_js_get_optional_heap_object_pointer:e}},setInstance:o=>{},createExports:o=>({})}}async function P(h){const r=await L(h);return h.wasi.initialize(r.instance),r.swift.main(),r}async function L(h){const r=h.WebAssembly||WebAssembly,o=h.module,{wasi:t}=h,e=new W({}),s=await q(),n={javascript_kit:e.wasmImports,wasi_snapshot_preview1:t.wasiImport},i={getInstance:()=>c,getExports:()=>l,_swift:e};s.addImports(n,i),h.addToCoreImports?.(n,i);let a,c,l;if(o instanceof r.Module)a=o,c=await r.instantiate(a,n);else if(typeof Response=="function"&&(o instanceof Response||o instanceof Promise))if(typeof r.instantiateStreaming=="function"){const u=await r.instantiateStreaming(o,n);a=u.module,c=u.instance}else{const u=await(await o).arrayBuffer();a=await r.compile(u),c=await r.instantiate(a,n)}else a=await r.compile(o),c=await r.instantiate(a,n);return c=h.instrumentInstance?.(c,{_swift:e})??c,e.setInstance(c),s.setInstance(c),l=s.createExports(c),{instance:c,swift:e,exports:l}}async function F(h){const r=h.args??[],o=h.onStdoutLine??(s=>console.log(s)),t=h.onStderrLine??(s=>console.error(s)),e=new I([U,...r],[],[new x(new D([])),k.lineBuffered(s=>{o(s)}),k.lineBuffered(s=>{t(s)}),new R("/",new Map)],{debug:!1});return{module:h.module,wasi:Object.assign(e,{setInstance(s){e.inst=s}})}}const N=async(h,r,o)=>{const t=await fetch(h);if(!t.ok)throw new Error(`Failed to fetch wasm module: ${t.status} ${t.statusText}`);const e=t.headers.get("Content-Length");let s=e?Number(e):null;(!t.body||!s||Number.isNaN(s))&&(s=r);const n=t.body.getReader(),i=[];let a=0;for(;;){const{done:f,value:d}=await n.read();if(f)break;d&&(i.push(d),a+=d.length,o(a/s))}const c=a,l=new Uint8Array(c);let u=0;for(const f of i)l.set(f,u),u+=f.length;return o(1),l.buffer};async function $(h,r,o,t){t(0);let e=await N(new URL(h,import.meta.url),r,t);t(1),await new Promise(n=>setTimeout(n,o));const s=await F({module:e});return await P(s)}const J=9155218,M=document.getElementById("progress-bar"),O=h=>{if(!M)return;let r=Math.min(Math.max(h??1,.005),1);M.style.transform=`scaleX(${r})`};O(0);await $("./wasm/App.wasm",J,200,h=>{O(h)}).then(h=>{});
